name: Build Check

on:
  push:
    branches: [main, develop]
  pull_request:
    branches: [main, develop]

jobs:
  build-esp32:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Fix file permissions
        run: sudo chown -R $(id -u):$(id -g) .

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'

      - name: Install Ruby dependencies
        run: gem install serialport

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract repository owner (lowercase)
        id: repo_owner
        run: echo "owner=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Load version from .env
        id: version
        run: echo "ESP_IDF_VERSION=$(grep ESP_IDF_VERSION .env | cut -d '=' -f2)" >> $GITHUB_OUTPUT

      - name: Pull Docker image from GHCR
        run: docker pull ghcr.io/${{ steps.repo_owner.outputs.owner }}/fmruby-esp32-build:${{ steps.version.outputs.ESP_IDF_VERSION }}

      - name: Tag image for Rakefile
        run: docker tag ghcr.io/${{ steps.repo_owner.outputs.owner }}/fmruby-esp32-build:${{ steps.version.outputs.ESP_IDF_VERSION }} ghcr.io/family-mruby/fmruby-esp32-build:latest

      - name: Build ESP32
        run: rake build:esp32

      # - name: Upload ESP32 artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: fmruby-graphics-audio-esp32
      #     path: |
      #       build/fmruby-graphics-audio.elf
      #       build/fmruby-graphics-audio.bin
      #       build/bootloader/bootloader.bin
      #       build/partition_table/partition-table.bin
      #     retention-days: 7

  build-linux:
    runs-on: ubuntu-latest
    steps:
      - name: Checkout repository
        uses: actions/checkout@v4
        with:
          submodules: recursive
          fetch-depth: 0

      - name: Fix file permissions
        run: sudo chown -R $(id -u):$(id -g) .

      - name: Setup Ruby
        uses: ruby/setup-ruby@v1
        with:
          ruby-version: '3.4'

      - name: Install Ruby dependencies
        run: gem install serialport

      - name: Log in to GitHub Container Registry
        uses: docker/login-action@v3
        with:
          registry: ghcr.io
          username: ${{ github.actor }}
          password: ${{ secrets.GITHUB_TOKEN }}

      - name: Extract repository owner (lowercase)
        id: repo_owner
        run: echo "owner=$(echo ${{ github.repository_owner }} | tr '[:upper:]' '[:lower:]')" >> $GITHUB_OUTPUT

      - name: Load version from .env
        id: version
        run: echo "ESP_IDF_VERSION=$(grep ESP_IDF_VERSION .env | cut -d '=' -f2)" >> $GITHUB_OUTPUT

      - name: Pull Docker image from GHCR
        run: docker pull ghcr.io/${{ steps.repo_owner.outputs.owner }}/fmruby-esp32-build:${{ steps.version.outputs.ESP_IDF_VERSION }}

      - name: Tag image for Rakefile
        run: docker tag ghcr.io/${{ steps.repo_owner.outputs.owner }}/fmruby-esp32-build:${{ steps.version.outputs.ESP_IDF_VERSION }} ghcr.io/family-mruby/fmruby-esp32-build:latest

      - name: Build Linux target
        run: rake build:linux

      # - name: Upload Linux artifacts
      #   uses: actions/upload-artifact@v4
      #   with:
      #     name: fmruby-graphics-audio-linux
      #     path: build/fmruby-graphics-audio.elf
      #     retention-days: 7
